#!/usr/bin/env bash

# Based on pwyde's dotfiles (https://github.com/pwyde/dotfiles)

# Variables for dotfiles repo
git_host="github.com"
git_user="spraybot"
git_repo="dotfiles"
git_url="https://${git_host}/${git_user}/"

# Config environment variables
CONFIG_ROS_DISTRO="humble"

# Set system type
system_type=$(uname -s)

# Set Zsh configuration directory.
export ZDOTDIR="${HOME}/.config/zsh"

## Colorize output.
# shellcheck disable=SC2034
red="\033[91m"
# shellcheck disable=SC2034
green="\033[92m"
# shellcheck disable=SC2034
blue="\033[94m"
# shellcheck disable=SC2034
yellow="\033[93m"
# shellcheck disable=SC2034
white="\033[97m"
# shellcheck disable=SC2034
no_color="\033[0m"


print_header() {
    echo -e "${blue}
       _     _   ___ _ _
     _| |___| |_|  _|_| |___ ___
   _| . | . |  _|  _| | | -_|_ -|
  |_|___|___|_| |_| |_|_|___|___|${yellow}
  BOOTSTRAP SCRiPT${white}
  ${git_url}${git_repo}${no_color}
" >&1
}

print_footer() {
    echo -e "${blue}
  Bootstrap of dotfiles completed!${yellow}
  Log out${blue} and${yellow} login${blue} to apply changes!${white}
  See README for more information;
  ${git_url}${git_repo}/.github/README.md${no_color}
" >&1
}

print_msg() {
    echo -e "${green}=>${no_color}${white}" "${@}" "${no_color}" >&1
}

print_error() {
    echo -e "${red}=> ERROR:${no_color}${white}" "${@}" "${no_color}" >&2
}

install_prezto() {
	if [ ! -d ${ZDOTDIR:-$HOME}/.zprezto/ ]; then
		print_msg "Installing Prezto..."
		git clone --recursive https://github.com/sorin-ionescu/prezto.git "${ZDOTDIR:-$HOME}/.zprezto"
	else
		print_msg "Updating Prezto..."
		zprezto-update
	fi	
}

install_shell_extensions() {
	print_msg "Installing shell extensions"
	if [ "$system_type" = "Darwin" ]; then  
		brew install bat htop thefuck direnv
	else
		# Dependencies
		sudo apt install curl python3-argcomplete python3-pip -y
		sudo apt install bat htop thefuck direnv grc -y

		# Setup grc
		rm "${HOME}/.grc"
		ln -sf "${HOME}/.config/grc" "${HOME}/.grc"
	fi
	curl -sS https://webinstall.dev/zoxide | bash
	bash <(curl https://raw.githubusercontent.com/ellie/atuin/main/install.sh)
	git-force-clone https://github.com/junegunn/fzf.git ${ZDOTDIR:-$HOME}/.fzf && ${ZDOTDIR:-$HOME}/.fzf/install --no-update-rc --completion --key-bindings
}

install_ros_extensions() {
	if [ "$system_type" = "Linux" ]; then  
		pip3 install --user git+https://github.com/eduidl/rtui.git

		print_msg "Optimizing DDS configuration"
		# Reduces latency in Cyclone DDS (https://docs.ros.org/en/humble/How-To-Guides/DDS-tuning.html)
		sudo sysctl -w net.core.rmem_max=2147483647 net.core.rmem_default=2147483647
		echo -e "net.core.rmem_max=2147483647\nnet.core.rmem_default=2147483647\n" | sudo tee /etc/sysctl.d/60-cyclonedds.conf
		sudo sysctl -w net.ipv4.ipfrag_high_thresh=134217728 net.ipv4.ipfrag_time=3
		echo -e "net.ipv4.ipfrag_high_thresh=134217728\nnet.ipv4.ipfrag_time=3\n" | sudo tee -a /etc/sysctl.d/60-cyclonedds.conf
	fi
}

setup_zsh_configs() {
	CONFIG_FILE="${ZDOTDIR:-$HOME}/config"
	echo -e "# Autogenerated Config File (Not to be tracked on git or modified)\n" > ${CONFIG_FILE}
	# TODO: Loop ad set all config variable automatically
	echo -e "export CONFIG_ROS_DISTRO=${CONFIG_ROS_DISTRO}" >> ${CONFIG_FILE}

	# Use zoxide instead of cd
	echo -e "alias cd='z'" >> ${CONFIG_FILE}		

	# Fix bat name clash
	if [ "$system_type" = "Linux" ]; then  
		mkdir -p ~/.local/bin
		ln -s /usr/bin/batcat ~/.local/bin/bat
	fi
	echo -e "alias cat='bat'" >> ${CONFIG_FILE}		

	# To show file previews using bat in fzf
	echo -e "export FZF_DEFAULT_OPTS=\"--preview 'bat --color=always --style=numbers --line-range=:500 {}'\"" >> ${CONFIG_FILE}

	CUSTOM_ZSHRC="${ZDOTDIR:-$HOME}/custom_zshrc"
	if [ ! -f "${CUSTOM_ZSHRC}" ]; then
    	echo -e "# Device specific zshrc file (Not to be tracked on git)" >${CUSTOM_ZSHRC}
	fi
}

setup_system() {
	sudo chown -R $USER:$USER /opt

	if [ "$system_type" = "Linux" ]; then  
		sudo apt install terminator -y
	fi
}

bootstrap_zsh() {
    print_msg "Bootstrapping Zsh..."
    hash zsh 2>/dev/null || {
		echo "Installing Zsh."
		sudo apt install zsh -y
	}
	install_prezto
	install_shell_extensions
	install_ros_extensions
	# Copy default Zsh configurations files from prezto.
	for file in "zlogin" "zlogout" "zprofile" "zshenv" ; do
		cp -f ${ZDOTDIR:-$HOME}/.zprezto/runcoms/${file} ${ZDOTDIR:-$HOME}/
    done
	 
	print_msg "Setting up Zsh configurations files..."
    # Array for Zsh configuration directory/files.
    zsh_dotfiles=("zlogin" "zlogout" "zprofile" "zshenv" "zshrc")
    # Delete default Zsh configuration files if present.
    for file in "${zsh_dotfiles[@]}"; do
        [ -e "${HOME}/.${file}" ] && rm -rf "${HOME:?}/.${file}" >/dev/null 2>&1
    
	    # Create symlinks to Zsh configuration files.
	    ln -sf "${ZDOTDIR}/${file}" "${ZDOTDIR}/.${file}"
    done
    print_msg "Set Zsh as default shell..."
    # Set default shell to Zsh.
    sudo chsh -s "$(command -v zsh)"
    print_msg "Adding system-wide Zsh configuration options..."
    # Set path to Zsh configuration files (system-wide configuration). We want
    # to do this to avoid as many dotfiles as possible in user home directory.
    # shellcheck disable=SC2016
    echo 'export ZDOTDIR="${HOME}/.config/zsh"' | \
    sudo tee --append /etc/zsh/zshenv >/dev/null 2>&1
}

setup_git() {
	# git config --global user.name "Shrijit Singh"
	# git config --global user.email "shrijitsingh99@gmail.com"
	git config --global core.excludesfile ${HOME}/.config/git/.gitignore
	if [ "$system_type" = "Darwin" ]; then  
		brew install git-extras
	else
		sudo apt install git-extras -y
	fi
	if ! ls ${HOME}/.ssh | grep -q id_ed25519 ; then
		print_msg "Generating SSH key..." 
		ssh-keygen -t ed25519 -C "$(git config user.email)"
	fi
}

update_yadm_repo() {
    print_msg "Updating the yadm repo origin URL..."
    yadm remote set-url origin "git@${git_host}:${git_user}/${git_repo}.git"
}

print_msg "Detected system type: ${system_type}"

print_header
setup_git
bootstrap_zsh
setup_zsh_configs
setup_system
update_yadm_repo
print_footer

# Reload shell with changes
exec zsh
